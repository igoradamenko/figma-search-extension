#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const iconFiles = fs.readdirSync(path.resolve(__dirname, '../icons'))
  .map(iconPath => ({
    name: iconPath.replace('.svg', ''),
    content: fs.readFileSync(path.resolve(__dirname, '../icons/', iconPath), 'utf-8'),
  }));

const iconStyles = iconFiles.map(({ name, content }) => {
  return `.${name}::before {
  background-image: url('data:image/svg+xml,${encodeURIComponent(content)}')
}`;
}).join('\n\n');

const startMarker = '/* AUTOGENERATED ICON STYLES START */';
const endMarker = '/* AUTOGENERATED ICON STYLES END */';

const popupCSSPath = path.resolve(__dirname, '../extension/popup.css');
const popupCSS = fs.readFileSync(popupCSSPath, 'utf-8');

const startIndex = popupCSS.indexOf(startMarker);
const endIndex = popupCSS.indexOf(endMarker);

if (startIndex === -1 || endIndex === -1) {
  console.error('Can not find markers');
  process.exit(1);
}

const popupCSSBeforeMarker = popupCSS.slice(0, startIndex).trim();
const popupCSSAfterMarker = popupCSS.slice(endIndex + endMarker.length).trim();

const resultFile = [popupCSSBeforeMarker, startMarker, iconStyles, endMarker, popupCSSAfterMarker].join('\n\n');

fs.writeFileSync(popupCSSPath, resultFile);
